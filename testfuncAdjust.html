<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    :root {
        --bg-color: #1a1a1a;
        --secondary-bg-color: #222;
        --card-bg-color: #2a2a2a;
        --accent-color: #ffcb6b;
        --text-color: #e0e0e0;
        --label-color: #ee4545;
        --input-bg-color: #3b3b3b;
        --button-bg-color: #ff7f4c;
        --table-header-bg: #4a2a2a;
        --table-row-bg-odd: #331e1e;
        --table-row-bg-even: #3c2424;
        --shadow-dark: 0 4px 15px rgba(0,0,0,0.4);
        --shadow-light: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 30px 20px;
        background: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        box-sizing: border-box;
    }
    
    .container {
        display: flex;
        flex-direction: row;
        gap: 30px;
        width: 100%;
    }
    .product-change-price-table {
        width: 30%;
    }
    
    .product-datas-price-table {
        width: 70%;
    }
    
    h1, h2, h3 {
        color: var(--accent-color);
        margin-bottom: 20px;
        font-weight: 700;
        border-bottom: 3px solid var(--accent-color);
        padding-bottom: 8px;
        font-size: 2rem;
        letter-spacing: 0.03em;
    }
    
    section {
        background-color: var(--secondary-bg-color);
        color: var(--text-color);
        padding: 25px 30px;
        border-radius: 16px;
        margin-bottom: 30px;
        box-shadow: var(--shadow-dark);
        transition: background-color 0.3s ease;
    }
    
    section:hover {
        background-color: var(--card-bg-color);
    }
    
    label {
        font-weight: 600;
        color: var(--label-color);
        display: block;
        margin-top: 15px;
        margin-bottom: 6px;
        font-size: 1rem;
    }
    
    input, textarea, select {
        width: 100%;
        padding: 12px 14px;
        margin-bottom: 18px;
        font-size: 1rem;
        border: none;
        border-radius: 10px;
        background-color: var(--input-bg-color);
        color: var(--text-color);
        box-shadow: inset 2px 2px 6px rgba(0,0,0,0.5), inset -2px -2px 6px rgba(255,255,255,0.05);
        transition: background-color 0.25s ease, box-shadow 0.25s ease;
        resize: vertical;
        box-sizing: border-box;
    }
    
    input:focus, textarea:focus, select:focus {
        background-color: #4e1212;
        box-shadow: 0 0 10px var(--accent-color);
        outline: none;
        color: #fff;
    }
    
    .product-card {
        background: #330909;
        padding: 24px 28px;
        border-radius: 14px;
        box-shadow: inset 0 0 12px var(--accent-color);
        margin-top: 30px;
    }
    
    .price-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 3rem;
    }
    
    .price-controls .btn-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    button {
        background-color: var(--button-bg-color);
        color: #fff;
        border: none;
        padding: 14px 26px;
        font-size: 1.1rem;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        box-shadow: 0 4px 14px rgba(255,76,76,0.5);
        transition: background-color 0.3s ease, transform 0.15s ease;
        user-select: none;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    
    button:hover, button:focus {
        background-color: #ff1f1f;
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(255,76,76,0.6);
        outline: none;
    }
    .price-table-wrapper {
            overflow-x: auto; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏°‡∏µ Scrollbar ‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏ô */
            width: 100%;
        }
        
        .price-table {
            min-width: 600px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß */
            /* ... (‡πÇ‡∏Ñ‡πâ‡∏î CSS ‡∏Ç‡∏≠‡∏á .price-table ‡πÄ‡∏î‡∏¥‡∏°) ... */
        }

        .table-scroll {
        max-height: 600px;  
        overflow-y: auto;
        border: 1px solid #ccc; /* optional */
        }

        /* fix header sticky (optional) */
        .price-table thead th {
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
        }

    .price-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
        background-color: transparent;
        margin-top: 20px;
    }
    
    .price-table thead th {
        background-color: var(--table-header-bg);
        color: #fff;
        font-weight: 700;
        padding: 14px 12px;
        border-radius: 8px 8px 0 0;
        text-align: center;
        font-size: 1rem;
        user-select: none;
    }
    
    .price-table tbody tr {
        background-color: var(--table-row-bg-odd);
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(255, 75, 75, 0.2);
        transition: background-color 0.3s ease;
    }
    
    .price-table tbody tr:nth-child(even) {
        background-color: var(--table-row-bg-even);
    }
    
    .price-table tbody tr:hover {
        background-color: #5e3535;
    }
    
    .price-table td {
        padding: 14px 10px;
        text-align: center;
        color: #ffe5e5;
        font-size: 1rem;
        vertical-align: middle;
    }
    
    .price-table td input,
    .price-table td select {
        width: 90px;
        padding: 8px 10px;
        font-size: 1rem;
        border-radius: 8px;
        border: none;
        background-color: #fff3f3;
        color: #4a1a1a;
        box-shadow: inset 1px 1px 4px #a94444;
        text-align: center;
        transition: background-color 0.3s ease;
        display: block;
        margin: 5px auto;
    }
    
    .price-table td input:focus,
    .price-table td select:focus {
        background-color: #ffdadad9;
        outline: none;
        box-shadow: 0 0 8px var(--accent-color);
    }
    
    .add-price-box {
        display: flex;
        flex-direction: row;
        gap: 20px;
    }

    .product-list-preview p {
        background-color: #1e1e1e;
        padding: 8px 12px;
        border-radius: 6px;
        margin-bottom: 5px;
        border: 1px solid rgba(255, 107, 107, 0.2);
        transition: background-color 0.2s ease;
    }

    .product-list-preview p:hover {
        background-color: #2b1111;
    }
    
    .product-datas {
        width: 97%;
    }

    /* Responsive Design */
    @media (max-width: 992px) {
        .container {
            flex-direction: column;
            align-items: stretch;
            max-width: 100%;
            width: 100%;
        }

        .product-change-price-table,
        .product-datas-price-table {
            width: 100%;
        }

        .add-price-box {
            flex-direction: column;
            gap: 15px;
        }
    }
    
    @media (max-width: 768px) {
        body {
            padding: 15px;
        }
        
        h1, h2, h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }
    
        section {
            padding: 20px;
            margin-bottom: 25px;
        }

        .price-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .price-controls select {
            width: 100%;
        }
    
        .price-controls .btn-group {
            flex-direction: column;
            gap: 10px;
        }
    
        button {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
        }
    
        .price-table {
            display: block;
        }

        .price-table thead {
            display: none;
        }
    
        .price-table tbody tr {
            display: block;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(255, 76, 76, 0.4);
            padding: 10px 0;
        }

        .price-table td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 107, 107, 0.4);
            position: relative;
        }

        .price-table td:last-child {
            border-bottom: none;
        }
    
        .price-table td::before {
            content: attr(data-label);
            font-weight: bold;
            color: #ffb3b3;
            text-transform: uppercase;
            white-space: nowrap;
        }
    
        .price-table td input,
        .price-table td select {
            width: 55%;
            margin: 0;
            text-align: right;
            display: inline-block;
        }
    }
    
    @media (max-width: 480px) {
        h1, h2, h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        section {
            padding: 15px;
        }

        .price-table td {
            flex-direction: column;
            align-items: flex-start;
        }

        .price-table td::before {
            margin-bottom: 5px;
        }

        .price-table td input,
        .price-table td select {
            width: 100%;
            text-align: left;
        }
    }
</style>

</head>
<body>

<div class="container">

    <section class="product-change-price-table">
        <div class="promotion-box">
            <h3>üéÅ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà)</h3>
            <div class="control-group">
                <label for="promoProductSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
                <select id="promoProductSelect">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
                </select>
            </div>

            <div class="control-group">
                <label for="promotionTypeSelect">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô:</label>
                <select id="promotionTypeSelect">
                    <option value="none">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                    <option value="discount">‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤</option>
                    <option value="buyOneGetOne">‡∏ã‡∏∑‡πâ‡∏≠ 1 ‡πÅ‡∏ñ‡∏° 1</option>
                </select>
            </div>

            <div class="control-group">
                <label for="promotionTagSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tag:</label>
                <select id="promotionTagSelect">
                    <option value="none">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                    <option value="special">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
                    <option value="promotion">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</option>
                    <option value="bestseller">‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</option>
                </select>
            </div>

            <div class="control-group">
                <label for="promotionStartTimeInput">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤:</label>
                <input type="datetime-local" id="promotionStartTimeInput" />
            </div>

            <div class="control-group">
                <label for="promotionFinishTimeInput">‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤:</label>
                <input type="datetime-local" id="promotionFinishTimeInput" />
            </div>

            <div class="control-group">
                <label for="promoScopeSelect">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</label>
                <select id="promoScopeSelect" onchange="updatePromoScopeUI()">
                    <option value="all">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>
                    <option value="province">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
                    <option value="district">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>
                </select>
            </div>
            <div id="promoProvinceScope" class="control-group" style="display:none;">
                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</label>
                <select id="promoProvinceSelect"></select>
            </div>
            <div id="promoDistrictScope" class="control-group" style="display:none;">
                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:</label>
                <select id="promoDistrictSelect">
                    <option value="">-- ‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ --</option>
                </select>
            </div>

            <div class="control-group">
                <label>‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:</label>
                <div style="display: flex; gap: 5px;">
                    <select id="promoPriceOperator" style="width: auto;">
                        <option value="add">+</option>
                        <option value="subtract">-</option>
                    </select>
                    <input type="number" id="promoPriceValue" placeholder="( + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ ) ‡πÅ‡∏•‡∏∞ ( - ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ ) " />
                </div>
            </div>

            <button onclick="applyPromotionPrice()">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</button>

        </div>
    </section>
    

    <section class="product-datas-price-table">
        <h2>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</h2>
  
        <div class="price-controls">

            <div class="btn-group">
                <button id="savePriceBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤</button>
                <button id="downloadJsonBtn">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON</button>
                <button id="resetDataBtn">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div><br>

            <select id="provinceSelect">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>
            </select>

        </div>
  
        <div class="table-scroll">
            <table id="priceTable" class="price-table">
                <thead>
                <tr>
                    <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                    <th>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</th>
                    <th>PSDB01</th>
                    <th>PSDB02</th>
                    <th>PSDT01</th>
                    <th>PSDT02</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </section>

</div>




<script>
    let data = null;
    let currentIndex = null;
    let changeLog = [];
    let cart = [];

    const STORAGE_KEY = 'poon_data';
    const EXPIRES_KEY = 'poon_data_expires';
    const EXPIRE_MS = 72 * 60 * 60 * 1000;
    const WARNING_BEFORE = 3 * 60 * 1000;

    const SELECTED_PROVINCE_KEY = 'selected_province';
    const SELECTED_PRODUCT_INDEX_KEY = 'selected_product_index';
 
    init();

    function init() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        const expiresAt = localStorage.getItem(EXPIRES_KEY);

        if (savedData && expiresAt && Date.now() < Number(expiresAt)) {
            data = JSON.parse(savedData);
            populateProvinceDropdown();
            populateProductSelects();
            updatePromoScopeUI(); 
            attachEventListeners();

            const selectedProvince = localStorage.getItem(SELECTED_PROVINCE_KEY);
            if (selectedProvince) {
                document.getElementById('provinceSelect').value = selectedProvince;
                renderPriceTable(selectedProvince);
            }
            scheduleExpiryWarning(Number(expiresAt));
        } else {
            fetch('./poon-singto-datas.json')
            .then(res => res.json())
            .then(json => {
                data = json;
                
                populateProvinceDropdown();
                populateProductSelects();
                updatePromoScopeUI(); 
                attachEventListeners();
                saveToStorage();

                const selectedProvince = localStorage.getItem(SELECTED_PROVINCE_KEY);
                if (selectedProvince) {
                    document.getElementById('provinceSelect').value = selectedProvince;
                    renderPriceTable(selectedProvince);
                }
                scheduleExpiryWarning(Date.now() + EXPIRE_MS);
            });
        }
    }

    function attachEventListeners() {
        document.getElementById('savePriceBtn').addEventListener('click', () => {
            Swal.fire({
                icon: 'success',
                title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                showConfirmButton: false,
                timer: 1500
            });
            console.log('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:', data.prices);
            saveToStorage();
        });

        document.getElementById('downloadJsonBtn').addEventListener('click', () => {
            if (!data) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î', 'error');
                return;
            }
            downloadJSON(data, '[update]poon-singto-datas.json');
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå JSON ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        });

        document.getElementById('resetDataBtn').addEventListener('click', () => {
            Swal.fire({
                title: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                text: '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå poon-singto-datas.json ‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢!',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    clearStorageAndReload();
                }
            });
        });
    }

    function saveToStorage() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        const expiresAt = Date.now() + EXPIRE_MS;
        localStorage.setItem(EXPIRES_KEY, expiresAt.toString());
        scheduleExpiryWarning(expiresAt);
    }

    function scheduleExpiryWarning(expiresAt) {
        const now = Date.now();
        const timeUntilWarning = expiresAt - WARNING_BEFORE - now;
        if (timeUntilWarning > 0) {
            setTimeout(() => showExpiryWarning(expiresAt), timeUntilWarning);
        } else if (expiresAt - now > 0) {
            showExpiryWarning(expiresAt);
        } else {
            clearStorage();
        }
    }

    function showExpiryWarning(expiresAt) {
        const timeLeft = expiresAt - Date.now();
        if (timeLeft <= 0) {
            clearStorage();
            return;
        }
        let countdown = Math.floor(timeLeft / 1000);
        const timer = setInterval(() => {
            countdown--;
            const minutes = Math.floor(countdown / 60);
            const seconds = countdown % 60;
            Swal.update({
                html: `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô <b>${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ ${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</b><br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î <b>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤`
            });
            if (countdown <= 0) {
                clearInterval(timer);
                Swal.close();
                clearStorage();
            }
        }, 1000);

        Swal.fire({
            icon: 'warning',
            title: '‚ö†Ô∏è ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß',
            html: '',
            showConfirmButton: false,
            allowOutsideClick: false,
            allowEscapeKey: false
        });
    }

    function clearStorage() {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(EXPIRES_KEY);
        Swal.fire('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'info').then(() => {
            location.reload();
        });
    }

    function populateProvinceDropdown() {
        const select = document.getElementById('provinceSelect');
        select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>';
        if (!data || !data.prices) return;
        Object.keys(data.prices).forEach(province => {
            const option = document.createElement('option');
            option.value = province;
            option.textContent = province;
            select.appendChild(option);
        });
    }

    document.getElementById('provinceSelect').addEventListener('change', function () {
        const selectedProvince = this.value;
        localStorage.setItem(SELECTED_PROVINCE_KEY, selectedProvince);
        if (selectedProvince) {
            renderPriceTable(selectedProvince);
        } else {
            document.querySelector('#priceTable tbody').innerHTML = '';
        }
    });

    function renderPriceTable(selectedProvince) {
        const tbody = document.querySelector('#priceTable tbody');
        tbody.innerHTML = '';
        if (!data || !data.prices[selectedProvince]) {
            tbody.innerHTML = `<tr><td colspan="6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏µ‡πâ</td></tr>`;
            return;
        }
        const districtsObj = data.prices[selectedProvince];
        const districts = Object.keys(districtsObj);
        const productIds = ['PSDB01', 'PSDB02', 'PSDT01', 'PSDT02'];

        districts.forEach((district, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${index + 1}</td><td>${district}</td>`;
            productIds.forEach(pid => {
                let displayPrice = '';
                let originalPriceDisplay = '';
                let discountPercent = '';
                let promoTagHtml = '';
                let priceData = data.prices[selectedProvince][district][pid];

                if (typeof priceData === 'object' && priceData !== null) {
                    displayPrice = priceData.price;
                    if (priceData.oldprice) {
                        originalPriceDisplay = `‡πÄ‡∏î‡∏¥‡∏°: ${priceData.oldprice} ‡∏ö‡∏≤‡∏ó`;
                        const discount = priceData.oldprice - priceData.price;
                        discountPercent = `(‡∏•‡∏î ${((discount / priceData.oldprice) * 100).toFixed(0)}%)`;
                    }
                    if (priceData.promotionTag && priceData.promotionTag !== 'none') {
                        promoTagHtml = `<span class="promo-tag">${priceData.promotionTag}</span>`;
                    }
                } else if (typeof priceData === 'string' || typeof priceData === 'number') {
                    displayPrice = priceData;
                }

                tr.innerHTML += `<td>
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        ${promoTagHtml}
                        <input type="text" class="price-input" value="${displayPrice}"
                            data-province="${selectedProvince}"
                            data-district="${district}"
                            data-pid="${pid}"
                            style="width: 60px;" />
                        <select class="price-select" data-province="${selectedProvince}"
                            data-district="${district}" data-pid="${pid}">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                            <option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢" ${displayPrice === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢' ? 'selected' : ''}>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</option>
                            <option value="‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤" ${displayPrice === '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤' ? 'selected' : ''}>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤</option>
                        </select>
                        ${originalPriceDisplay ? `<span style="text-decoration: line-through; color: #888; font-size: 0.8em;">${originalPriceDisplay}</span>` : ''}
                        ${discountPercent ? `<span style="color: red; font-weight: bold; font-size: 0.8em;">${discountPercent}</span>` : ''}
                    </div>
                </td>`;
            });
            tbody.appendChild(tr);
        });
    }

    document.addEventListener('change', e => {
        if (e.target.classList.contains('price-input') || e.target.classList.contains('price-select')) {
            const el = e.target;
            const prov = el.dataset.province;
            const dist = el.dataset.district;
            const pid = el.dataset.pid;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (!data.prices[prov]) data.prices[prov] = {};
            if (!data.prices[prov][dist]) data.prices[prov][dist] = {};
            
            const existingPriceData = data.prices[prov][dist][pid];
            let oldPrice = (typeof existingPriceData === 'object' && existingPriceData !== null) ? existingPriceData.price : existingPriceData;

            if (el.classList.contains('price-input')) {
                let val = el.value.trim();
                let newPrice = null;
                if (!isNaN(val) && val !== '') {
                    newPrice = Number(val);
                }
                data.prices[prov][dist][pid] = newPrice;
            
                const selectEl = document.querySelector(`select.price-select[data-province="${prov}"][data-district="${dist}"][data-pid="${pid}"]`);
                if (selectEl) selectEl.value = '';
            } else if (el.classList.contains('price-select')) {
                const val = el.value;
                data.prices[prov][dist][pid] = val;
                const inputEl = document.querySelector(`input.price-input[data-province="${prov}"][data-district="${dist}"][data-pid="${pid}"]`);
                if (inputEl) inputEl.value = '';
            }
            saveToStorage();
            renderPriceTable(prov);
            console.log(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥: ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ${prov}, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ${dist}, ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${pid} =`, data.prices[prov][dist][pid]);
        }
    });

    function populateProductSelects() {
        const products = [
            { id: 'PSDB01', name: '‡∏õ‡∏π‡∏ô‡∏ñ‡∏∏‡∏á‡πÅ‡∏î‡∏á' },
            { id: 'PSDB02', name: '‡∏õ‡∏π‡∏ô‡∏ñ‡∏∏‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß' },
            { id: 'PSDT01', name: '‡∏õ‡∏π‡∏ô‡∏ú‡∏á‡πÅ‡∏î‡∏á' },
            { id: 'PSDT02', name: '‡∏õ‡∏π‡∏ô‡∏ú‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß' }
        ];

        const promoSelect = document.getElementById('promoProductSelect');
        promoSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
        products.forEach(p => {
            const o = document.createElement('option');
            o.value = p.id;
            o.textContent = `${p.id} - ${p.name}`;
            promoSelect.appendChild(o);
        });

        const adjustSelect = document.getElementById('productSelectInPriceAdjust');
        if (adjustSelect) {
            adjustSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
            products.forEach(p => {
                const o = document.createElement('option');
                o.value = p.id;
                o.textContent = `${p.id} - ${p.name}`;
                adjustSelect.appendChild(o);
            });
        }
    }

    document.getElementById('productSelect').addEventListener('change', function () {
        currentIndex = this.value;
        localStorage.setItem(SELECTED_PRODUCT_INDEX_KEY, currentIndex);
        if (currentIndex === '') {
            document.getElementById('productForm').style.display = 'none';
            return;
        }
        const p = data.products[currentIndex];
        document.getElementById('productForm').style.display = 'block';
        ['id', 'name', 'description', 'typeWork', 'minimum', 'minimumcomment', 'delivery', 'feature', 'detail']
            .forEach(field => document.getElementById(field).value = p[field] || '');
    });

    function saveChanges() {
        if (currentIndex === null || currentIndex === '') return;
        const p = data.products[currentIndex];
        ['name', 'description', 'typeWork', 'minimum', 'minimumcomment', 'delivery', 'feature', 'detail']
            .forEach(field => p[field] = document.getElementById(field).value);
        saveToStorage();
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
    }

    function downloadJSON(data, filename) {
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    function updatePromoScopeUI() {
        const scope = document.getElementById('promoScopeSelect').value;
        document.getElementById('promoProvinceScope').style.display = (scope !== 'all') ? 'block' : 'none';
        document.getElementById('promoDistrictScope').style.display = (scope === 'district') ? 'block' : 'none';

        if (scope !== 'all' && data) {
            const provinceSelect = document.getElementById('promoProvinceSelect');
            provinceSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>';
        
            if (data.prices) {
                Object.keys(data.prices).forEach(province => {
                    const opt = document.createElement('option');
                    opt.value = province;
                    opt.textContent = province;
                    provinceSelect.appendChild(opt);
                });
            }
        
            provinceSelect.onchange = function () {
                const selectedProvince = this.value;
                const districtSelect = document.getElementById('promoDistrictSelect');
                districtSelect.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ --</option>';
        
                if (selectedProvince && data.prices && data.prices[selectedProvince]) {
                    Object.keys(data.prices[selectedProvince]).forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = d;
                        districtSelect.appendChild(opt);
                    });
                }
            };
        }
    }
    
    function applyPromotionPrice() {
        const productId = document.getElementById('promoProductSelect').value;
        const promoPriceOperator = document.getElementById('promoPriceOperator').value;
        const promoPriceValue = parseFloat(document.getElementById('promoPriceValue').value);
        const promoType = document.getElementById('promotionTypeSelect').value;
        const promoTag = document.getElementById('promotionTagSelect').value;
        const startTime = document.getElementById('promotionStartTimeInput').value;
        const finishTime = document.getElementById('promotionFinishTimeInput').value;

        const scope = document.getElementById('promoScopeSelect').value;
        const province = document.getElementById('promoProvinceSelect')?.value || '';
        const district = document.getElementById('promoDistrictSelect')?.value || '';

        if (!productId || isNaN(promoPriceValue)) {
            Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '', 'warning');
            return;
        }

        const updatePrices = (prov, dist) => {
            const currentPriceData = data.prices[prov][dist][productId];
            let oldPrice;
            let currentPrice;
            
            // Determine oldPrice and currentPrice based on existing data structure
            if (typeof currentPriceData === 'object' && currentPriceData !== null) {
                oldPrice = currentPriceData.oldprice || currentPriceData.price;
                currentPrice = currentPriceData.price;
            } else {
                oldPrice = currentPriceData;
                currentPrice = currentPriceData;
            }
            
            if (typeof currentPrice === 'number') {
                let newPrice;
                if (promoPriceOperator === 'add') {
                    newPrice = currentPrice + promoPriceValue;
                } else if (promoPriceOperator === 'subtract') {
                    newPrice = currentPrice - promoPriceValue;
                } else {
                    newPrice = currentPrice;
                }
                
                data.prices[prov][dist][productId] = {
                    price: newPrice,
                    promotionType: promoType,
                    promotionTag: promoTag,
                    promotionStartTime: startTime,
                    promotionFinishTime: finishTime,
                    oldprice: oldPrice // Store the original price before the promotion
                };
            }
        };

        if (scope === 'all') {
            for (const prov in data.prices) {
                for (const dist in data.prices[prov]) {
                    if (data.prices[prov][dist][productId]) {
                        updatePrices(prov, dist);
                    }
                }
            }
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${productId} ‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        } else if (scope === 'province' && province) {
            if (!data.prices[province]) {
                Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', '', 'error');
                return;
            }
            for (const dist in data.prices[province]) {
                if (data.prices[province][dist][productId]) {
                    updatePrices(province, dist);
                }
            }
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${productId} ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ${province} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        } else if (scope === 'district' && province && district) {
            if (!data.prices[province] || !data.prices[province][district]) {
                Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', '', 'error');
                return;
            }
            if (data.prices[province][district][productId]) {
                updatePrices(province, district);
            }
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${productId} ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ${district} ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ${province} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        } else {
            Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '', 'warning');
            return;
        }
        
        saveToStorage();
        const selectedProvinceInTable = document.getElementById('provinceSelect').value;
        if(selectedProvinceInTable) {
            renderPriceTable(selectedProvinceInTable);
        }
    }

    function clearStorageAndReload() {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(EXPIRES_KEY);
        localStorage.removeItem(SELECTED_PROVINCE_KEY);
        localStorage.removeItem(SELECTED_PRODUCT_INDEX_KEY);
        Swal.fire('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà', 'success').then(() => {
            location.reload();
        });
    }

    function clearStorage() {
        clearStorageAndReload();
    }
</script>



</body>
</html>